# Phase 2.1: Type System Cleanup - Implementation Plan

**Phase:** 2.1
**Priority:** P0 (Critical - Blocking)
**Estimated Duration:** 2-4 hours
**Status:** Planning
**Blockers:** None

---

## Overview

Fix all 41 mypy type errors to enable strict type checking in Phase 2. Currently, mypy runs in CI and pre-push hooks but is non-blocking. After completing this work, mypy will become a blocking check, preventing type errors from being introduced.

## Goals

1. **Eliminate All Type Errors** - Reduce from 41 errors to 0
2. **Enable Strict Type Checking** - Make mypy blocking in CI and pre-push hook
3. **Improve Code Quality** - Better IDE support, fewer runtime errors
4. **Establish Type Standards** - Document patterns for future development
5. **No Breaking Changes** - Fix types without changing functionality

## Current State

**Mypy Status:**
- Total errors: **41**
- Affected files: **10**
- Status: Non-blocking (warning only)

**Error Distribution:**

```
src/aetherlens/api/rate_limit.py        9 errors
src/aetherlens/api/routes/health.py     9 errors
src/aetherlens/api/routes/devices.py    7 errors
src/aetherlens/api/main.py              3 errors
src/aetherlens/api/database.py          3 errors
src/aetherlens/api/metrics.py           3 errors
src/aetherlens/security/jwt.py          2 errors
src/aetherlens/api/logging.py           2 errors
src/aetherlens/api/dependencies.py      2 errors
src/aetherlens/api/routes/auth.py       1 error
```

## Error Analysis by Category

### Category 1: Missing Return Type Annotations (15 errors)

**Problem:** Functions declared without `-> Type` return annotation

**Files Affected:**
- `rate_limit.py` (lines 19, 61)
- `logging.py` (line 52)
- `database.py` (line 16)
- `routes/health.py` (lines 75, 118, 141)
- `routes/auth.py` (line 34)
- `routes/devices.py` (lines 17, 75, 107, 156, 208)
- `main.py` (lines 83, 103, 110)

**Examples:**
```python
# Before (error)
def __init__(self):
    self.requests = defaultdict(list)

# After (fixed)
def __init__(self) -> None:
    self.requests: dict[str, list[float]] = defaultdict(list)
```

**Solution:**
- Add `-> None` for functions that don't return values
- Add explicit return types for functions that return values
- Use `-> dict[str, Any]` for generic dict returns

### Category 2: Missing Type Parameters for Generics (10 errors)

**Problem:** Generic types (dict, Callable, AsyncGenerator) without type parameters

**Files Affected:**
- `dependencies.py` (lines 16, 62)
- `routes/devices.py` (lines 21, 75, 107, 156, 208)
- `metrics.py` (line 42)
- `main.py` (line 24)

**Examples:**
```python
# Before (error)
async def get_current_user(...) -> dict:
    return dict(user)

# After (fixed)
async def get_current_user(...) -> dict[str, Any]:
    return dict(user)
```

**Solution:**
- Replace `dict` with `dict[str, Any]`
- Replace `Callable` with `Callable[[args], return_type]`
- Replace `AsyncGenerator` with `AsyncGenerator[yield_type, send_type]`

### Category 3: Returning Any from Typed Functions (3 errors)

**Problem:** Function returns `Any` but declares specific return type

**Files Affected:**
- `security/jwt.py` (line 74)
- `api/metrics.py` (lines 47, 66)

**Examples:**
```python
# Before (error)
def decode_token(self, token: str) -> dict[str, Any]:
    return jwt.decode(token, ...)  # jwt.decode returns Any

# After (fixed)
def decode_token(self, token: str) -> dict[str, Any]:
    payload: dict[str, Any] = jwt.decode(token, ...)
    return payload
```

**Solution:**
- Cast return value explicitly to declared type
- Use intermediate variable with type annotation
- Consider changing return type if appropriate

### Category 4: Missing Library Stubs (3 errors)

**Problem:** Third-party libraries without type stubs

**Files Affected:**
- `database.py` (line 5) - asyncpg
- `database.py` (line 50) - untyped call

**Examples:**
```python
# Before (error)
import asyncpg  # Module has no stubs

# After (fixed - Option 1: Install stubs)
import asyncpg  # With types-asyncpg installed

# After (fixed - Option 2: Suppress warning)
import asyncpg  # type: ignore[import-untyped]
```

**Solution:**
- Install type stub packages where available (`types-asyncpg`)
- Use `# type: ignore[import-untyped]` for libraries without stubs
- Add inline type annotations for untyped calls

### Category 5: Union Type Handling (2 errors)

**Problem:** Accessing attributes on Union types without None check

**Files Affected:**
- `rate_limit.py` (line 69)

**Examples:**
```python
# Before (error)
client_ip = request.client.host  # request.client can be None

# After (fixed)
if request.client is None:
    return JSONResponse(...)
client_ip = request.client.host
```

**Solution:**
- Add explicit None checks before accessing attributes
- Use walrus operator for cleaner code: `if (client := request.client) is None:`
- Consider default values: `client_ip = request.client.host if request.client else "unknown"`

### Category 6: Cannot Determine Type (5 errors)

**Problem:** mypy cannot infer type of variable

**Files Affected:**
- `routes/health.py` (lines 96, 96, 105, 107)

**Examples:**
```python
# Before (error)
db_check = check_database()  # mypy can't determine return type

# After (fixed)
db_check: HealthCheck = check_database()
```

**Solution:**
- Add explicit type annotations to variables
- Ensure called functions have return type annotations
- Use type assertions where necessary

### Category 7: Wrong Attribute Names (2 errors)

**Problem:** Using incorrect exception class name

**Files Affected:**
- `security/jwt.py` (line 84)

**Examples:**
```python
# Before (error)
except jwt.JWTError as e:  # JWTError doesn't exist

# After (fixed)
except (jwt.InvalidTokenError, jwt.DecodeError) as e:
```

**Solution:**
- Check library documentation for correct exception names
- Update to correct exception classes
- Consider catching broader exceptions if appropriate

### Category 8: Type Mismatch in Collections (1 error)

**Problem:** Wrong type being added to typed collection

**Files Affected:**
- `routes/devices.py` (line 44)

**Examples:**
```python
# Before (error)
values: list[int] = []
values.append(device_type)  # device_type is str

# After (fixed)
values: list[Any] = []
values.append(device_type)
```

**Solution:**
- Fix collection type to match usage: `list[Any]`
- Or fix data type being added to match collection type
- Consider using Union types if multiple types needed

## Implementation Approach

### Strategy: Incremental File-by-File Fix

Fix errors file-by-file in order of complexity (simple â†’ complex):

**Phase 1: Quick Wins (30 minutes)**
1. Missing return type annotations (15 errors)
2. Missing generic type parameters (10 errors)

**Phase 2: Library Issues (15 minutes)**
3. Install/configure library stubs (3 errors)

**Phase 3: Logic Fixes (45 minutes)**
4. Union type handling (2 errors)
5. Cannot determine type (5 errors)
6. Returning Any (3 errors)
7. Wrong attribute names (2 errors)
8. Collection type mismatches (1 error)

**Phase 4: Validation (30 minutes)**
9. Run mypy repeatedly until 0 errors
10. Run full test suite
11. Update CI configuration

### File-by-File Implementation Order

#### 1. `src/aetherlens/api/dependencies.py` (2 errors) âš¡ EASY

**Errors:**
- Line 16: Missing type parameters for generic type "dict"
- Line 62: Missing type parameters for generic type "dict"

**Fix:**
```python
# Line 16
async def get_current_user(...) -> dict[str, Any]:

# Line 62
async def require_admin(current_user: dict[str, Any] = Depends(get_current_user)) -> dict[str, Any]:
```

**Estimated Time:** 5 minutes

---

#### 2. `src/aetherlens/api/logging.py` (2 errors) âš¡ EASY

**Errors:**
- Line 52: Function is missing a return type annotation (and arguments)

**Fix:**
```python
# Line 52
async def log_request(...) -> None:
```

**Estimated Time:** 5 minutes

---

#### 3. `src/aetherlens/api/routes/auth.py` (1 error) âš¡ EASY

**Errors:**
- Line 34: Function is missing a return type annotation

**Fix:**
```python
# Line 34
async def login(...) -> dict[str, str]:
```

**Estimated Time:** 5 minutes

---

#### 4. `src/aetherlens/api/main.py` (3 errors) âš¡ EASY

**Errors:**
- Line 24: Missing type parameters for generic type "AsyncGenerator"
- Line 83: Function is missing a return type annotation
- Line 103: Function is missing a return type annotation
- Line 110: Function is missing a return type annotation

**Fix:**
```python
from typing import AsyncGenerator

# Line 24
async def lifespan(app: FastAPI) -> AsyncGenerator[None, None]:

# Line 83
@app.on_event("startup")
async def startup() -> None:

# Line 103
@app.on_event("shutdown")
async def shutdown() -> None:

# Line 110
def custom_openapi() -> dict[str, Any]:
```

**Estimated Time:** 10 minutes

---

#### 5. `src/aetherlens/security/jwt.py` (2 errors) âš¡ MEDIUM

**Errors:**
- Line 74: Returning Any from function declared to return "dict[str, Any]"
- Line 84: Module has no attribute "JWTError"

**Fix:**
```python
# Line 74
def decode_token(self, token: str) -> dict[str, Any]:
    try:
        payload: dict[str, Any] = jwt.decode(
            token, settings.secret_key, algorithms=[settings.jwt_algorithm]
        )
        return payload
    # ...

# Line 84 - Check PyJWT documentation for correct exception
except (jwt.InvalidTokenError, jwt.DecodeError) as e:
```

**Estimated Time:** 15 minutes

---

#### 6. `src/aetherlens/api/database.py` (3 errors) ðŸ”¶ MEDIUM

**Errors:**
- Line 5: Skipping analyzing "asyncpg": module is installed, but missing library stubs
- Line 16: Function is missing a return type annotation
- Line 50: Call to untyped function "DatabaseManager" in typed context

**Fix:**
```python
# Line 5 - Check if types-asyncpg exists, otherwise ignore
import asyncpg  # type: ignore[import-untyped]

# Line 16
def __init__(self) -> None:
    self.pool: asyncpg.Pool | None = None

# Line 50
db_manager: DatabaseManager = DatabaseManager()
```

**Estimated Time:** 20 minutes

---

#### 7. `src/aetherlens/api/metrics.py` (3 errors) ðŸ”¶ MEDIUM

**Errors:**
- Line 42: Missing type parameters for generic type "Callable"
- Line 47: Returning Any from function declared to return "Response"
- Line 66: Returning Any from function declared to return "Response"

**Fix:**
```python
from typing import Callable, Any
from starlette.responses import Response

# Line 42
async def metrics_middleware(
    request: Request,
    call_next: Callable[[Request], Awaitable[Response]]
) -> Response:

# Lines 47, 66 - Cast response
response: Response = await call_next(request)
return response
```

**Estimated Time:** 20 minutes

---

#### 8. `src/aetherlens/api/rate_limit.py` (9 errors) ðŸ”¶ MEDIUM

**Errors:**
- Line 19: Function is missing a return type annotation
- Line 55: Function is missing a type annotation for one or more arguments
- Line 57: Call to untyped function "InMemoryRateLimiter" in typed context
- Line 61: Function is missing a return type annotation (and arguments)
- Line 69: Item "None" of "Address | None" has no attribute "host"

**Fix:**
```python
from typing import Any
from starlette.types import ASGIApp

# Line 19
def __init__(self) -> None:
    self.requests: dict[str, list[float]] = defaultdict(list)

# Line 55
def __init__(
    self,
    app: ASGIApp,
    requests_per_minute: int = 60,
    requests_per_hour: int = 1000
) -> None:

# Line 57
self.limiter: InMemoryRateLimiter = InMemoryRateLimiter()

# Line 61
async def dispatch(self, request: Request, call_next: Callable) -> Response:

# Line 69 - Handle None client
if request.client is None:
    return JSONResponse(
        status_code=status.HTTP_400_BAD_REQUEST,
        content={"detail": "Client address unavailable"}
    )
client_ip = request.client.host
```

**Estimated Time:** 30 minutes

---

#### 9. `src/aetherlens/api/routes/health.py` (9 errors) ðŸ”¶ COMPLEX

**Errors:**
- Line 75: Function is missing a return type annotation
- Lines 96, 96, 105, 107: Cannot determine type of "db_check" and "timescale_check"
- Lines 118, 141: Function is missing a return type annotation

**Fix:**
```python
from typing import Any

# Line 75
async def check_database() -> dict[str, Any]:
    return {"status": "healthy", ...}

# Lines 96, 105
db_check: dict[str, Any] = await check_database()
timescale_check: dict[str, Any] = await check_timescale()

# Line 118
async def check_timescale() -> dict[str, Any]:

# Line 141
async def check_redis() -> dict[str, Any]:
```

**Estimated Time:** 25 minutes

---

#### 10. `src/aetherlens/api/routes/devices.py` (7 errors) ðŸ”¶ COMPLEX

**Errors:**
- Line 17: Function is missing a return type annotation
- Line 21: Missing type parameters for generic type "dict"
- Line 44: Argument 1 to "append" of "list" has incompatible type "str"; expected "int"
- Lines 75, 107, 156, 208: Function is missing a return type annotation and dict type parameters

**Fix:**
```python
from typing import Any

# Line 17
async def list_devices(...) -> dict[str, Any]:

# Line 21
values: list[Any] = []  # Change from list[int] to list[Any]

# Line 44 - Now correctly typed
values.append(device_type)  # Works with list[Any]

# Lines 75, 107, 156, 208
async def create_device(...) -> dict[str, Any]:
async def get_device(...) -> dict[str, Any]:
async def update_device(...) -> dict[str, Any]:
async def delete_device(...) -> dict[str, Any]:
```

**Estimated Time:** 30 minutes

---

## Implementation Tasks

### Pre-Implementation Setup

- [ ] Create feature branch: `phase2/fix-type-errors`
- [ ] Review mypy configuration in `pyproject.toml`
- [ ] Install any missing type stub packages
- [ ] Backup current working state

### Phase 1: Quick Wins (30 min)

- [ ] **Fix** `api/dependencies.py` (2 errors) - Add dict type parameters
- [ ] **Fix** `api/logging.py` (2 errors) - Add return type annotation
- [ ] **Fix** `api/routes/auth.py` (1 error) - Add return type annotation
- [ ] **Fix** `api/main.py` (3 errors) - Add AsyncGenerator and return types
- [ ] **Test** Run mypy, verify 8 errors fixed (41 â†’ 33)

### Phase 2: Library Issues (15 min)

- [ ] **Research** Check if `types-asyncpg` package exists
- [ ] **Fix** `api/database.py` (3 errors) - Install stubs or add type: ignore
- [ ] **Test** Run mypy, verify 3 errors fixed (33 â†’ 30)

### Phase 3: Logic Fixes (45 min)

- [ ] **Fix** `security/jwt.py` (2 errors) - Cast return, fix exception name
- [ ] **Fix** `api/metrics.py` (3 errors) - Callable types, Response casting
- [ ] **Fix** `api/rate_limit.py` (9 errors) - Return types, None handling
- [ ] **Fix** `api/routes/health.py` (9 errors) - Return types, type annotations
- [ ] **Fix** `api/routes/devices.py` (7 errors) - Return types, list typing
- [ ] **Test** Run mypy after each file fix

### Phase 4: Validation & Integration (30 min)

- [ ] **Verify** Run mypy with no errors: `mypy src/`
- [ ] **Test** Run unit tests: `pytest tests/unit/ -v`
- [ ] **Test** Run security tests: `pytest tests/security/ -v`
- [ ] **Test** Run integration tests: `pytest tests/integration/ -v`
- [ ] **Coverage** Verify coverage still â‰¥47%
- [ ] **Lint** Run ruff: `ruff check src/ tests/`
- [ ] **Format** Run black: `black src/ tests/`
- [ ] **Format** Run isort: `isort src/ tests/`

### Phase 5: Make mypy Blocking (15 min)

- [ ] **Update** `.github/workflows/ci.yml` - Remove `continue-on-error: true` from mypy
- [ ] **Update** `scripts/pre-push.bat` - Change mypy from warning to blocking
- [ ] **Document** Update DEVELOPMENT-WORKFLOW.md - Note mypy is now blocking
- [ ] **Commit** Changes with detailed commit message

### Phase 6: Documentation (15 min)

- [ ] **Create** Completion summary: `2.1-type-system-cleanup-completion.md`
- [ ] **Update** `plans/phase-2/PHASE-2-KICKOFF.md` - Mark task as complete
- [ ] **Update** `plans/README.md` - Add completion status
- [ ] **Document** Type checking patterns in CONTRIBUTING.md

## Acceptance Criteria

### Required for Completion

- [ ] âœ… **Zero mypy errors** - `mypy src/` returns exit code 0
- [ ] âœ… **All tests passing** - Unit, security, and integration tests pass
- [ ] âœ… **Coverage maintained** - Coverage â‰¥47% (no regression)
- [ ] âœ… **Lint clean** - ruff, black, isort all pass
- [ ] âœ… **mypy blocking in CI** - CI fails if type errors introduced
- [ ] âœ… **mypy blocking in pre-push** - Hook fails if type errors introduced
- [ ] âœ… **Documentation updated** - DEVELOPMENT-WORKFLOW.md reflects blocking mypy

### Quality Gates

- [ ] No use of `# type: ignore` without detailed comment explaining why
- [ ] All public functions have explicit return type annotations
- [ ] All function parameters have type annotations
- [ ] Generic types (dict, list, Callable) have type parameters
- [ ] No `Any` types without justification comment

## Timeline

**Total Estimated Time:** 2.5 - 3 hours

| Phase | Tasks | Estimated Time | Actual Time |
|-------|-------|----------------|-------------|
| **Pre-Implementation** | Setup, research | 10 min | - |
| **Phase 1: Quick Wins** | 4 files, 8 errors | 30 min | - |
| **Phase 2: Libraries** | 1 file, 3 errors | 15 min | - |
| **Phase 3: Logic Fixes** | 5 files, 30 errors | 75 min | - |
| **Phase 4: Validation** | Testing, verification | 30 min | - |
| **Phase 5: Make Blocking** | CI/hook updates | 15 min | - |
| **Phase 6: Documentation** | Summaries, updates | 15 min | - |
| **TOTAL** | 10 files, 41 errors | **3 hours** | - |

**Best Case:** 2 hours (if no unexpected issues)
**Expected Case:** 2.5-3 hours
**Worst Case:** 4 hours (if complex refactoring needed)

## Testing Strategy

### During Implementation

**After Each File:**
```cmd
REM Quick check
.\venv\Scripts\python -m mypy src/aetherlens/[file].py

REM Full check
.\venv\Scripts\python -m mypy src/
```

**After Each Phase:**
```cmd
REM Run all checks
scripts\format.bat
.\venv\Scripts\pytest tests/unit/ -v
```

### Final Validation

**Complete Test Suite:**
```cmd
REM Format code
scripts\format.bat

REM Type check
.\venv\Scripts\python -m mypy src/

REM Unit tests with coverage
.\venv\Scripts\pytest tests/unit/ -v --cov=src/aetherlens --cov-report=term

REM Security tests
.\venv\Scripts\pytest tests/security/ -v

REM Integration tests
.\venv\Scripts\pytest tests/integration/ -v
```

**Expected Results:**
- mypy: 0 errors found âœ…
- Unit tests: 7/7 passing âœ…
- Security tests: 3/3 passing âœ…
- Coverage: â‰¥47% âœ…

## Risks & Mitigation

### Risk 1: Library Stubs Not Available

**Impact:** Medium
**Probability:** Low
**Mitigation:**
- Use `# type: ignore[import-untyped]` for imports
- Add inline type annotations for function calls
- Consider contributing stubs to typeshed

### Risk 2: Complex Type Inference Issues

**Impact:** Medium
**Probability:** Medium
**Mitigation:**
- Start with simple files to build confidence
- Use explicit type annotations liberally
- Consult mypy documentation for complex cases
- Add `# type: ignore[specific-error]` as last resort with comment

### Risk 3: Breaking Changes from Type Fixes

**Impact:** High
**Probability:** Low
**Mitigation:**
- Run full test suite after each file
- Review changes carefully for logic modifications
- Keep fixes minimal - only what's needed for types
- Use git commits per file for easy rollback

### Risk 4: Test Coverage Regression

**Impact:** Medium
**Probability:** Low
**Mitigation:**
- Monitor coverage after each phase
- Don't delete tests or test code
- Run coverage check before committing

## Success Metrics

### Primary Metrics

- **Type Errors:** 41 â†’ 0 (100% reduction)
- **Type-Checked Files:** 10 files fully typed
- **Blocking Status:** mypy blocking in CI and pre-push

### Secondary Metrics

- **Test Coverage:** Maintained at â‰¥47%
- **Build Time:** No significant increase
- **Developer Experience:** Better IDE autocomplete and error detection

## Notes

### Type Checking Best Practices

**DO:**
- âœ… Add explicit return types to all functions
- âœ… Use specific types (dict[str, Any]) over generic (dict)
- âœ… Add type annotations to variables when mypy can't infer
- âœ… Check for None before accessing Union type attributes
- âœ… Use type stubs for third-party libraries when available

**DON'T:**
- âŒ Use `Any` without justification
- âŒ Use `# type: ignore` without specific error code and comment
- âŒ Change function logic to satisfy type checker
- âŒ Skip testing after type changes

### Common Patterns

**Pattern 1: Handling Optional Types**
```python
# Good
if value is not None:
    result = value.attribute

# Better
result = value.attribute if value is not None else default
```

**Pattern 2: Casting Returns**
```python
# Good
def get_data() -> dict[str, Any]:
    data: dict[str, Any] = external_call()
    return data
```

**Pattern 3: Generic Collections**
```python
# Good
results: list[dict[str, Any]] = []
cache: dict[str, list[str]] = defaultdict(list)
```

## References

- [mypy Documentation](https://mypy.readthedocs.io/)
- [Python Type Hints](https://docs.python.org/3/library/typing.html)
- [PEP 484 - Type Hints](https://www.python.org/dev/peps/pep-0484/)
- [Phase 2 Kickoff Plan](./PHASE-2-KICKOFF.md)
- [Development Workflow](../../DEVELOPMENT-WORKFLOW.md)

---

**Ready to start?** Create branch `phase2/fix-type-errors` and begin with Phase 1: Quick Wins! ðŸš€

---

*Plan created: 2025-10-26*
*Status: Ready for Implementation*
*Estimated completion: 2-4 hours*
